// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================================================
// EXISTING MODELS (Activity Verification System)
// ============================================================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  role      String   @default("student") // "student" or "admin"
  image     String? // Profile picture from OAuth
  schoolId  String? // NEW: link to school for social proof
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Existing relations
  verifiedActivities     Verification[]              @relation("VerifierVerifications")
  studentActivities      Verification[]              @relation("StudentVerifications")
  activities             Activity[]
  organizationsCreated   Organization[]              @relation("OrganizationCreator")
  
  // NEW: Opportunities system relations
  school                  School?                     @relation(fields: [schoolId], references: [id])
  follows                 Follow[]
  saves                   SavedEdition[]
  petitions               Petition[]
  notifications           Notification[]
  
  // Volunteering/Alumni system relations
  opportunitiesPosted     VolunteeringOpportunity[]   @relation("OpportunityPoster")
  opportunitiesApproved   VolunteeringOpportunity[]   @relation("OpportunityApprover")
  participations          VolunteeringParticipation[] @relation("StudentParticipations")
  verifiedParticipations  VolunteeringParticipation[] @relation("ParticipationVerifier")
  studentGoals            VolunteeringGoal[]          @relation("StudentGoals")
  createdGoals            VolunteeringGoal[]          @relation("GoalCreator")
  alumniProfile           AlumniProfile?

  @@map("users")
}

model Verification {
  id            String   @id @default(cuid())
  activityId    String   @unique
  verifierId    String
  studentId     String
  status        String   @default("pending")
  verifierNotes String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  verifier User     @relation("VerifierVerifications", fields: [verifierId], references: [id])
  student  User     @relation("StudentVerifications", fields: [studentId], references: [id])
  activity Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)

  @@map("verifications")
}

model Activity {
  id              String   @id @default(cuid())
  studentId       String
  name            String
  category        String
  description     String
  role            String?
  supervisor      String?
  supervisorEmail String?
  organization    String?
  startDate       String
  endDate         String?
  hoursPerWeek    Float?
  totalHours      Float?
  status          String   @default("pending")
  studentNotes    String?
  attachments     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  student                   User                       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  verification              Verification?
  volunteeringParticipation VolunteeringParticipation?

  @@map("activities")
}

enum OrganizationStatus {
  PENDING
  APPROVED
  REJECTED
}

model Organization {
  id            String             @id @default(cuid())
  name          String
  description   String?
  category      String?
  leadership    String?
  presidentName String?
  isSchoolClub  Boolean            @default(true)
  contactEmail  String?
  status        OrganizationStatus @default(PENDING)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  createdById   String

  createdBy                 User                      @relation("OrganizationCreator", fields: [createdById], references: [id])
  volunteeringOpportunities VolunteeringOpportunity[]

  @@map("organizations")
}

// ============================================================================
// NEW MODELS (Opportunities Platform)
// ============================================================================

model Provider {
  id            String        @id @default(cuid())
  name          String
  slug          String        @unique
  website       String?
  logoUrl       String?
  description   String?
  verified      Boolean       @default(false)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  opportunities Opportunity[]

  @@map("providers")
}

model Opportunity {
  id          String           @id @default(cuid())
  slug        String           @unique
  name        String
  type        OpportunityType
  providerId  String?
  provider    Provider?        @relation(fields: [providerId], references: [id])
  modality    Modality
  structure   Structure
  teamMin     Int?
  teamMax     Int?
  geography   GeographyScope
  locationId  String?
  location    Location?        @relation(fields: [locationId], references: [id])
  description String?
  website     String?
  logoUrl     String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  editions    Edition[]
  domains     OpportunityDomain[]

  @@map("opportunities")
}

model Domain {
  id            String              @id @default(cuid())
  name          String              @unique
  slug          String              @unique
  description   String?
  parentId      String?
  parent        Domain?             @relation("DomainHierarchy", fields: [parentId], references: [id])
  children      Domain[]            @relation("DomainHierarchy")
  opportunities OpportunityDomain[]
  createdAt     DateTime            @default(now())

  @@map("domains")
}

model OpportunityDomain {
  id            String      @id @default(cuid())
  opportunityId String
  domainId      String
  opportunity   Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  domain        Domain      @relation(fields: [domainId], references: [id], onDelete: Cascade)

  @@unique([opportunityId, domainId])
  @@map("opportunity_domains")
}

model Edition {
  id                    String           @id @default(cuid())
  opportunityId         String
  opportunity           Opportunity      @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  cycle                 String // "2025-2026" or "2026 Summer"
  status                EditionStatus    @default(unknown)
  applicationOpens      DateTime?
  applicationCloses     DateTime?
  registrationDeadline  DateTime?
  eventStart            DateTime?
  eventEnd              DateTime?
  rollingDeadlines      Boolean          @default(false)
  // Awards (stored as JSON array in SQLite; normalized to string[] in API)
  awardTypes            Json? // ["cash", "scholarship", ...] as JSON
  alumniOutcomesNotable Boolean          @default(false)
  // Eligibility
  gradeMin              Int? // 6-12 typically
  gradeMax              Int?
  ageMin                Int?
  ageMax                Int?
  // Cost
  registrationFee       Float? // USD, nullable for free
  // Popularity metrics
  popularityScore       Int              @default(0)
  savesCount            Int              @default(0)
  followsCount          Int              @default(0)
  clicks30d             Int              @default(0)
  // Calendar integration
  icsUid                String?          @unique
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  follows               Follow[]
  saves                 SavedEdition[]
  participations        Participation[]
  notifications         Notification[]

  @@map("editions")
}

model Location {
  id            String        @id @default(cuid())
  country       String?
  state         String?
  city          String?
  timezone      String? // IANA timezone
  opportunities Opportunity[]

  @@map("locations")
}

model School {
  id             String          @id @default(cuid())
  name           String          @unique
  city           String?
  state          String?
  country        String?
  website        String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  users          User[]
  participations Participation[]

  @@map("schools")
}

model Participation {
  id        String   @id @default(cuid())
  schoolId  String
  editionId String
  school    School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  edition   Edition  @relation(fields: [editionId], references: [id], onDelete: Cascade)
  count     Int      @default(1)
  year      Int? // optional: year of participation
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, editionId])
  @@map("participations")
}

model SavedEdition {
  id        String   @id @default(cuid())
  userId    String
  editionId String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  edition   Edition  @relation(fields: [editionId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, editionId])
  @@map("saved_editions")
}

model Follow {
  id        String   @id @default(cuid())
  userId    String
  editionId String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  edition   Edition  @relation(fields: [editionId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, editionId])
  @@map("follows")
}

model Notification {
  id          String           @id @default(cuid())
  userId      String
  editionId   String
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  edition     Edition          @relation(fields: [editionId], references: [id], onDelete: Cascade)
  kind        NotificationKind
  scheduledAt DateTime
  deliveredAt DateTime?
  payload     Json?
  createdAt   DateTime         @default(now())

  @@index([userId, deliveredAt])
  @@map("notifications")
}

model Petition {
  id           String         @id @default(cuid())
  userId       String?
  user         User?          @relation(fields: [userId], references: [id], onDelete: SetNull)
  title        String
  url          String
  description  String?
  evidenceUrl  String?
  status       PetitionStatus @default(pending)
  reviewNotes  String?
  aiConfidence Float? // 0.0-1.0
  aiExtracted  Json? // AI-extracted fields
  reviewedAt   DateTime?
  reviewedBy   String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@map("petitions")
}

// ============================================================================
// ENUMS
// ============================================================================

enum OpportunityType {
  competition
  program
  scholarship
  internship
  conference
  volunteer
  course
  hackathon
}

enum Modality {
  in_person
  hybrid
  online
}

enum Structure {
  team
  individual
  either
}

enum GeographyScope {
  global
  us_national
  state_province
  local_regional
}

enum EditionStatus {
  open
  upcoming
  closed
  unknown
}

enum NotificationKind {
  deadline_soon
  new_dates
  status_change
  reminder
}

enum PetitionStatus {
  pending
  needs_review
  approved
  rejected
}

// ============================================================================
// NEW MODELS (Volunteering & Alumni System)
// ============================================================================

model VolunteeringOpportunity {
  id             String  @id @default(cuid())
  title          String
  description    String
  organization   String // Organization name
  organizationId String? // Optional link to Organization model
  category       String // e.g., "Environment", "Education", "Healthcare", etc.
  location       String? // City, address, or "Remote"
  isOnline       Boolean @default(false) // Strictly online opportunity
  contactEmail   String?
  contactPhone   String?
  website        String?

  // Time & Commitment
  startDate       DateTime
  endDate         DateTime?
  isOngoing       Boolean   @default(false)
  hoursPerSession Float?
  totalHours      Float?
  commitmentLevel String? // "Low", "Medium", "High"

  // Requirements
  ageRequirement String? // e.g., "16+", "18+"
  skillsRequired String? // Comma-separated or JSON
  maxVolunteers  Int?

  // Status & Approval
  status       String  @default("pending") // "pending", "approved", "rejected", "archived"
  postedById   String // User who posted (student, club, admin)
  approvedById String? // Admin who approved

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  postedBy        User                        @relation("OpportunityPoster", fields: [postedById], references: [id])
  approvedBy      User?                       @relation("OpportunityApprover", fields: [approvedById], references: [id])
  organizationRef Organization?               @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  participations  VolunteeringParticipation[]

  @@map("volunteering_opportunities")
}

model VolunteeringParticipation {
  id            String  @id @default(cuid())
  opportunityId String? // Nullable for manual logs
  studentId     String
  activityId    String? @unique // Link to Activity model (if logged as activity)

  // Participation Details
  startDate    DateTime
  endDate      DateTime?
  totalHours   Float
  hoursPerWeek Float?
  status       String    @default("active") // "active", "completed", "cancelled"

  // Manual Log Fields (for past hours logging)
  isManualLog         Boolean @default(false)
  organizationName    String? // For manual logs
  activityName        String? // For manual logs
  activityDescription String? // For manual logs
  serviceSheetUrl     String? // URL to uploaded service sheet

  // Verification
  verified          Boolean   @default(false)
  verifiedBy        String? // User ID of verifier
  verifiedAt        DateTime?
  verificationNotes String?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  opportunity VolunteeringOpportunity? @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  student     User                     @relation("StudentParticipations", fields: [studentId], references: [id], onDelete: Cascade)
  activity    Activity?                @relation(fields: [activityId], references: [id], onDelete: SetNull)
  verifier    User?                    @relation("ParticipationVerifier", fields: [verifiedBy], references: [id], onDelete: SetNull)

  @@map("volunteering_participations")
}

model Settings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("settings")
}

model VolunteeringGoal {
  id          String    @id @default(cuid())
  studentId   String // Student the goal is for
  createdById String // Who created the goal (student, admin, or club president)
  goalType    String    @default("personal") // "personal", "admin_assigned", "club_recommended"
  targetHours Float // Target hours to reach
  targetDate  DateTime? // Optional target date
  description String? // Optional description/notes
  status      String    @default("active") // "active", "completed", "cancelled"
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  student   User @relation("StudentGoals", fields: [studentId], references: [id], onDelete: Cascade)
  createdBy User @relation("GoalCreator", fields: [createdById], references: [id], onDelete: Cascade)

  @@map("volunteering_goals")
}

enum AlumniPrivacy {
  ANONYMOUS
  PSEUDONYM
  FULL
}

model AlumniProfile {
  id               String         @id @default(cuid())
  userId           String         @unique
  privacy          AlumniPrivacy  @default(ANONYMOUS)
  displayName      String?
  contactEmail     String?
  intendedMajor    String?
  careerInterestTags String?      // JSON string array
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  // Relations
  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  applications AlumniApplication[]

  @@index([privacy])
  @@map("alumni_profiles")
}

model AlumniApplication {
  id              String   @id @default(cuid())
  alumniId        String
  sourceFileUrl   String
  sourceFileMime  String
  parseStatus     String   @default("pending") // "pending", "success", "failed"
  parseError      String?
  rawText         String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  alumniProfile      AlumniProfile         @relation(fields: [alumniId], references: [id], onDelete: Cascade)
  extractedActivities ExtractedActivity[]
  extractedEssays    ExtractedEssay[]
  admissionResults   AdmissionResult[]
  extractedAwards    ExtractedAward[]

  @@map("alumni_applications")
}

model ExtractedActivity {
  id            String  @id @default(cuid())
  applicationId String
  title         String
  description   String?
  role          String?
  organization  String?
  hours         Float?
  years         String? // e.g., "9-12" or "11-12"

  // Relations
  application AlumniApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@map("extracted_activities")
}

model ExtractedEssay {
  id            String  @id @default(cuid())
  applicationId String
  topic         String
  prompt        String?
  summary       String? // Short summary
  tags          String? // JSON string array

  // Relations
  application AlumniApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@map("extracted_essays")
}

model AdmissionResult {
  id            String  @id @default(cuid())
  applicationId String
  collegeName   String
  decision      String  // "admit", "waitlist", "deny"
  decisionRound String? // "ED", "EA", "RD"
  rankBucket    String? // "top5", "top10", "other"

  // Relations
  application AlumniApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([rankBucket])
  @@map("admission_results")
}

model ExtractedAward {
  id            String  @id @default(cuid())
  applicationId String
  title         String
  level         String? // "national", "state", "regional", "school"
  year          String? // e.g., "2023" or "11th grade"
  description   String?

  // Relations
  application AlumniApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@map("extracted_awards")
}
